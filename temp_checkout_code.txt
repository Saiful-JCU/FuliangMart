
# new checkout
def checkout(request, oid):
    order = CartOrder.objects.get(oid=oid)
    order_items = CartOrderItems.objects.filter(order=order)

    if request.method == "POST":
        code = request.POST.get('code')
        # print(code)
        coupon = Coupon.objects.filter(code=code, active=True).first()
        if coupon:
            if coupon in order.coupons.all():
                messages.warning(request, "Coupon already activated.")
                return redirect("martApp:checkout", order.oid)
            else:
                discount = order.price * coupon.discount / 100
                order.coupons.add(coupon)
                order.price -= discount
                order.saved += discount
                order.save()

                messages.success(request, "Coupon activated.")
                return redirect("martApp:checkout", order.oid)
        else:
            messages.warning(request, "Coupon Doesnot Exists.")
            return redirect("martApp:checkout", order.oid)


    context = {
        "order":order,
        "order_items":order_items
    }

    return render(request, "core/checkout.html", context)

# new checkout view
def save_checkout_info(request):
    cart_total_amount = 0
    # total_amount = 0

    if request.method == "POST":
        full_name = request.POST.get("full_name")
        email = request.POST.get("email")
        phone = request.POST.get("phone")
        house_address = request.POST.get("house")
        road_name = request.POST.get("road")
        city = request.POST.get("city")

        request.session['full_name'] = full_name
        request.session['email'] = email
        request.session['phone'] = phone
        request.session['house_address'] = house_address
        request.session['road_name'] = road_name
        request.session['city'] = city
        print(request.POST)
        
        if 'cart_data_obj' in request.session:
            for p_id, item in request.session['cart_data_obj'].items():
                cart_total_amount += int(item['qty']) * float(item['price'])

        order = CartOrder.objects.create(
            user = request.user,
            price = cart_total_amount,
            full_name = full_name,
            email = email,
            phone = phone,
            house_address=house_address,
            road_name=road_name,
            city = city,
        )

        del request.session['full_name']
        del request.session['email']
        del request.session['phone']
        del request.session['house_address']
        del request.session['road_name']
        del request.session['city']


        for p_id, item in request.session['cart_data_obj'].items():
                cart_total_amount += int(item['qty']) * float(item['price'])

                cart_order_products = CartOrderItems.objects.create(
                    order=order,
                    # invoice_no=f"INV-{order.id}-{product_id}",
                    invoice_no="INVOICE_NO" +str(order.id),
                    
                    # product_status="Pending",
                    items=item['title'],
                    image=item['image'], 
                    qty=int(item['qty']),
                    price=float(item['price']),
                    total=float(item['price']) * int(item['qty'])
                )

        return redirect("martApp:checkout", oid = order.oid)
    return redirect("martApp:checkout", order.oid)


@login_required 
def place_order(request):
    if request.method == "POST":
        cart_data = request.session.get('cart_data_obj', {})
        user = request.user

        # print("Cart data:", cart_data)
        # print("User:", user)  

        if not cart_data:
            messages.error(request, "Your cart is empty!")
            return redirect('martApp:cart')

        total_price = sum(
            float(item['price']) * int(item['qty']) for item in cart_data.values()
        )
        # print("Total price:", total_price) 

        try:
            # Create the order
            order = CartOrder.objects.create(
                user=user,
                price=total_price,
                paid_status=False, 
                product_status="Processing"
                # product_status= product_status
            )
            print("Order created:", order)

            # Add items to the order
            for product_id, item in cart_data.items():
                CartOrderItems.objects.create(
                    order=order,
                    invoice_no=f"INV-{order.id}-{product_id}",
                    product_status="Pending",
                    items=item['title'],
                    image=item['image'], 
                    qty=int(item['qty']),
                    price=float(item['price']),
                    total=float(item['price']) * int(item['qty'])
                )
            print("Order items created.")  

            # Clear the cart
            request.session['cart_data_obj'] = {}
            messages.success(request, "Your order has been placed successfully!")
            return redirect('martApp:order_success')

        except Exception as e:
            # print("Error placing order:", e) 
            messages.error(request, "An error occurred while placing your order.")
            return redirect('martApp:checkout')

    return redirect('martApp:cart')
#################################### views end here #################################3333


#################################### checkout start here #################################3333
{% extends 'partials/base.html' %}
{% load static %}
{% block content %}
    <!-- <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow"><i class="fi-rs-home mr-5"></i>Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <div class="container mb-80 mt-50">
            <div class="row">
                <div class="col-lg-8 mb-40">
                    <h1 class="heading-2 mb-10">Checkout</h1>
                    <div class="d-flex justify-content-between">
                        <h6 class="text-body">There are <span class="text-brand">{{ totalcartitems }}</span> products in your cart</h6>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-7">
                    <div class="row mb-50">
                        
                        <div class="col-lg-6">
                            <form method="post" class="apply-coupon">
                                <input type="text" placeholder="Enter Coupon Code...">
                                <button class="btn  btn-md" name="login">Apply Coupon</button>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <!-- <h4 class="mb-30">Bio Data</h4> -->
                        <!-- <h4 class="mb-30">Billing Details</h4>
                        <form method="post">
                            <div class="row">
                                <div class="form-group col-lg-6">
                                    <input type="text" required="" name="fname" value="{{ request.user.username|title }}" placeholder="Name *">
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group col-lg-6">
                                    <input type="text" name="mobail" value="" required="" placeholder="Phone *">
                                </div>
                                <div class="form-group col-lg-6">
                                    <input type="text" name="Home_Address" value="{{ active_address.address }}" required="" placeholder="Home Address *">
                                </div>
                                
                            </div>
                         
                        </form>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="border p-40 cart-totals ml-30 mb-50">
                        <div class="d-flex align-items-end justify-content-between mb-30">
                            <h4>Your Order</h4>
                            <h6 class="text-muted">Subtotal - <span class="text-brand">${{cart_total_amount|floatformat:2}}</span></h6>

                        </div>
                        <div class="divider-2 mb-30"></div>
                        <a href="{% url 'martApp:cart' %}" class="btn btn-fill-out btn-block mt-30 mb-40">Go back to Cart</a>
                        
                        <div class="table-responsive order_table checkout">
                            <table class="table no-border">
                                <tbody>
                                    {% for product_id, item in cart_data.items %}
                                    <tr>
                                        <td class="image product-thumbnail"><img src="{{ item.image }}" alt="#"></td>
                                        <td>
                                            <h6 class="w-160 mb-5"><a href="{% url 'martApp:product_detail' item.pid %}" class="text-heading">{{item.title}}</a></h6></span>
                                           
                                        </td>
                                        <td>
                                            <h6 class="text-muted pl-20 pr-20">x {{ item.qty }}</h6>
                                        </td>
                                        <td>
                                            <h5 class="text-muted">${{item.price}}</h5>
                                        </td>

                                        <td>
                                            <h5 class="text-brand">${% widthratio item.price 1 item.qty %}</h5>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="payment ml-30">
                        <h4 class="mb-30">Payment</h4>
                        <div class="payment_option">
                            <div class="custome-radio">
                                <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios3" checked="">
                                <label class="form-check-label" for="exampleRadios3" data-bs-toggle="collapse" data-target="#bankTranfer" aria-controls="bankTranfer">Direct Bank Transfer</label>
                            </div>
                            <div class="custome-radio">
                                <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios4" checked="">
                                <label class="form-check-label" for="exampleRadios4" data-bs-toggle="collapse" data-target="#checkPayment" aria-controls="checkPayment">Cash on delivery</label>
                            </div>
                            <div class="custome-radio">
                                <input class="form-check-input" required="" type="radio" name="payment_option" id="exampleRadios5" checked="">
                                <label class="form-check-label" for="exampleRadios5" data-bs-toggle="collapse" data-target="#paypal" aria-controls="paypal">Online Getway</label>
                            </div>
                        </div>
                        <div class="payment-logo d-flex">
                            <img class="mr-15" src="{% static 'assets/imgs/theme/icons/payment-paypal.svg' %}" alt="">
                            <img class="mr-15" src="{% static 'assets/imgs/theme/icons/payment-visa.svg' %}" alt="">
                            <img class="mr-15" src="{% static 'assets/imgs/theme/icons/payment-master.svg' %}" alt="">
                            <img src="{% static 'assets/imgs/theme/icons/payment-zapper.svg' %}" alt="">
                        </div>
                        <div class="w-50">
                            {{paypal_payment_button.render}}
                        </div>
                        <!-- <a href="#" class="btn btn-fill-out btn-block mt-30">Place an Order<i class="fi-rs-sign-out ml-15"></i></a> -->
                        <!-- <form action="{% url 'martApp:place_order' %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-fill-out btn-block mt-30">Place an Order<i class="fi-rs-sign-out ml-15"></i></button>
                        <button type="submit" class="btn btn-fill-out btn-block mt-30">Place an Order<i class="fi-rs-sign-out ml-15"></i></button> -->
                        <!-- </form>
                    </div>
                </div>
            </div>
        </div>
    </main> --> 

<!--////////////////////////////////// new code /////////////////////////////-->

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="{% url 'martApp:index' %}" rel="nofollow"><i class="fi-rs-home mr-5"></i>Home</a>
                <span></span> Shop <span></span> Checkout
            </div>
        </div>
    </div>
    <div class="container mb-80 mt-50">
        <div class="row">
            <div class="col-lg-8 mb-40">
                <h1 class="heading-2 mb-10">Checkout</h1>
                <div class="d-flex justify-content-between"></div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-7">
                <div class="row">
                    {% for o in order_items%}
                        <div class="col-lg-6">
                            <div class="card" style="max-width: 540px">
                                    <div class="row g-0">
                                    <div class="col-sm-4">
                                        <img src="{{o.image}}" style="width: 100%; height: 100%; object-fit: cover" class="rounded-start" alt="Card image" />
                                    </div>

                                    <div class="col-sm-8">
                                        <div class="card-body">
                                            <h5 class="card-title">{{o.items}}</h5>
                                            <p class="card-text fs-sm">{{o.qty}}</p>
                                            <p class="card-text fs-sm">${{o.price}}</p>
                                            <p class="card-text fs-sm">${{o.total}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor%}

                </div>
            </div>
            <div class="col-lg-5">
                <div class="border cart-totals mb-50">
                    <div class="d-flex align-items-end justify-content-between mb-30">
                        <h4>Order Summary</h4>
                    </div>

                    <div>
                        <div class="d-flex justify-content-between mb-2">
                            <p class="fw-bold">Tax</p>
                            <p>$0.00</p>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <p class="fw-bold">Shipping</p>
                            <p>$0.00</p>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <p class="fw-bold">Discount</p>
                            <p>${{order.saved}}</p>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <p class="fw-bold">Total</p>
                            <p>${{order.price}}</p>
                        </div>
                    </div>
                </div>

                <div class="row mb-50">
                    <div class="col-lg-12">
                        <form method="post" class="apply-coupon">
                            {% csrf_token %}
                            <input type="text" name="code" placeholder="Enter Coupon Code..." />
                            <button class="btn btn-md" type="submit" name="login">Apply Coupon</button>
                        </form>
                    </div>
                </div>

                <button class="btn w-100" style="background-color: blueviolet">Pay With Stripe (Credit or Debit Card)</button> <br>
                <form action="{% url 'martApp:place_order' %}" method="POST">
                    {% csrf_token %}
                
                    <button class="btn w-100 mt-1" style="background-color: rgb(39, 18, 228)">Cash In Delivery</button>
                </form>
                    <!-- <div id="paypal-button-container" class="mt-3"></div> -->
            </div>
        </div>
    </div>
</main>

    {% endblock content %}
    
#################################### checkout end here #################################3333



#################################### models start here #################################3333
class CartOrder(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    price = models.DecimalField(max_digits=12, decimal_places=2, default = "1.99")

    paid_status = models.BooleanField(default=False)
    order_date = models.DateTimeField(auto_now_add=True)

    product_status = models.CharField(choices = STATUS_CHOICE, max_length = 10, default = "Processing")
    sku = ShortUUIDField(null=True, blank=True, length=5, prefix = "SKU", max_length=20, alphabet="1234567890")
    oid = ShortUUIDField(null=True, blank=True, length=5, prefix = "OID", max_length=20, alphabet="1234567890")

    # billing details fields
    full_name = models.CharField(max_length=255, null=True, blank=True)
    email = models.EmailField(null=True, blank=True)
    phone = models.CharField(max_length=20, null=True, blank=True)
    house_address = models.CharField(max_length=255, null=True, blank=True)
    road_name = models.CharField(max_length=255, null=True, blank=True)
    city = models.CharField(max_length=100, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True, null=True, blank=True)

    saved = models.DecimalField(max_digits=12, decimal_places=2, default = "0.00")
    shipping_method = models.CharField(max_length=100, null=True, blank=True)

    traking_id = models.CharField(max_length=100, null=True, blank=True)
    traking_website_address = models.CharField(max_length=100, null=True, blank=True)

    stripe_payment_intent = models.CharField(max_length=100, null=True, blank=True)
    coupons = models.ManyToManyField("martApp.Coupon", blank=True)
    
    def __str__(self):
        return f"Order #{self.id} by {self.user.username}"

    class Meta:
        verbose_name_plural = "Cart Order"

#################################### models end here #################################3333


#################################### cart start here #################################3333

{% extends 'partials/base.html' %}
{% load static %}
{% block content %}
    <main class="main" id="cart-list">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow"><i class="fi-rs-home mr-5"></i>Home</a>
                    <span></span> Shop
                    <span></span> Cart
                </div>
            </div>
        </div>
        <div class="container mb-80 mt-50">
            <div class="row">
                <div class="col-lg-8 mb-40">
                    <h1 class="heading-2 mb-10">Your Cart</h1>
                    <div class="d-flex justify-content-between">
                        <h6 class="text-body">There are <span class="text-brand">{{ totalcartitems }}</span> products in your cart</h6>
                    </div>
                </div>
            </div>
            <form action="{% url 'martApp:save-checkout-info' %}" method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-lg-8">
                        <div class="table-responsive shopping-summery">
                            <table class="table table-wishlist">
                                <thead>
                                    <tr class="main-heading">
                                        
                                        <th scope="col">Product</th>
                                        <th scope="col">Title</th>
                                        <th scope="col">Unit Price</th>
                                        <th scope="col" class="text-center">Quantity</th>
                                        <th scope="col">Subtotal</th>
                                        <th scope="col" class="">Refresh</th>
                                        <th scope="col" class="end">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product_id, item in cart_data.items %}
                                    <tr class="pt-30">
                                        <td class="image product-thumbnail pt-40"><img src="{{ item.image }}" alt="#"></td>
                                        <td class="product-des product-name">
                                            <h6 class="mb-5"><a class="product-name mb-10 text-heading" href="{% url 'martApp:product_detail' item.pid %}">{{ item.title }}</a></h6>
                                        
                                        </td>
                                        <td class="price" data-title="Price">
                                            <h4 class="text-body">${{item.price|floatformat:2}}</h4>
                                        </td>
                                        <td class="text-center detail-info" data-title="Stock">
                                            <div class="mr-15">
                                                <input type="number" placeholder="Qty" class="w-25 product-qty-{{ product_id }}"  name="" value="{{ item.qty }}" id="">
                                            </div>
                                        </td>
                                        <td class="price" data-title="Price">
                                            <h4 class="text-brand">${% widthratio item.price 1 item.qty %} </h4>
                                        </td>
                                        <td class="action text-center" data-title="Remove"><a style="border: none; background: none;"  class="text-body update-product" data-product="{{ product_id }}"><i class="fi-rs-refresh"></i></a></td>
                                        <td class="action text-center" data-title="Remove"><a style="border: none; background: none;"  class="text-body delete-product" data-product="{{ product_id }}"><i class="fi-rs-trash"></i></a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="row mt-4">
                                <h4 class="mb-30">Bio Data</h4>
                                <div class="row">
                                    <div class="form-group col-lg-12">
                                        <label for="">Full Name</label>
                                        <input type="text" required="" name="full_name" value="{{request.user.username|title}}" placeholder="Full Name">
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label for="">Email</label>
                                        <input type="text" required="" name="email"  placeholder="mobile *" value="{{request.user.email}}">
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label for="">Mobile</label>
                                        <input type="text" name="phone" value="{{request.user.profile.phone}}" required="" placeholder="Phone *">
                                    </div>
                                </div>
                                <h4 class="mb-30">Shipping Details</h4>
                                <div class="row">
                                    <div class="form-group col-lg-6">
                                        <label for="">Address</label>
                                        <input type="text" name="house" value="{{ active_address.address }}" placeholder="House No.">
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label for="">Road</label>
                                        <input type="text" name="road"  placeholder="Road *" value="">
                                    </div>
                                    <div class="form-group col-lg-6">
                                        <label for="">City</label>
                                        <input type="text" name="city" value="" placeholder="city *">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="border p-md-4 cart-totals ml-30">
                            <div class="table-responsive">
                                <div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <p class="fw-bold">Tax</p>
                                        <p>$0</p>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <p class="fw-bold">Shipping</p>
                                        <p>$0</p>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <p class="fw-bold">Discount</p>
                                        <p>$0</p>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mb-2">
                                        <p class="fw-bold">Total</p>
                                        <p>${{cart_total_amount}}</p>
                                    </div>
                                </div>
                            </div>
                            {% if totalcartitems %}
                                <button type="submit" class="btn mb-20 w-100">Proceed To CheckOut<i class="fi-rs-sign-out ml-15"></i></button>
                            {% endif %}                    
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>
{% endblock content %}
#################################### cart end here #################################3333


#################################### coupons models start here #################################3333
class Coupon(models.Model):
    code = models.CharField(max_length = 50)
    discount = models.IntegerField(default = 1)
    active = models.BooleanField(default = True)

    def __str__(self):
        return self.code

#################################### coupon end here #################################3333

